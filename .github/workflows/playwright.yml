name: Playwright Tests (BrowserStack)

on:
  repository_dispatch:
    types: [trigger-xray-tests]

  workflow_dispatch:
    inputs:
      TAG:
        description: "Manual fallback: grep pattern or tag (ex: @login or SQP-1657)"
        required: true
        default: ""

env:
  BROWSERSTACK_LOCAL_IDENTIFIER: ${{ github.run_id }}

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------
      # 1. Checkout Code
      # ----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 2. Setup Node.js
      # ----------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ----------------------------------------------------
      # 2.5 Read keys from Jira payload (build Playwright grep)
      # ----------------------------------------------------
      - name: Read keys from Jira payload (build Playwright grep)
        shell: bash
        run: |
          echo "Event name: $GITHUB_EVENT_NAME"
          echo "----- GitHub Event Payload -----"
          cat "$GITHUB_EVENT_PATH"
          echo "--------------------------------"

          if [ "$GITHUB_EVENT_NAME" = "repository_dispatch" ]; then
            # Supports:
            #   ["SQP-1826","SQP-1797"] OR ["SQP-1826, SQP-1797"]
            RAW_KEYS=$(jq -r '
              .client_payload.testKeys
              | if type=="array" then join(",") else tostring end
            ' "$GITHUB_EVENT_PATH")

            # Build regex: SQP-1826|SQP-1797|...
            GREP_PATTERN=$(echo "$RAW_KEYS" \
              | tr ',' '\n' \
              | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
              | grep -E '^[A-Za-z]+-[0-9]+$' \
              | paste -sd'|' -)

            TEST_PLAN_KEY=$(jq -r '.client_payload.testPlanKey // ""' "$GITHUB_EVENT_PATH")

            echo "TEST_PLAN_KEY=$TEST_PLAN_KEY" >> $GITHUB_ENV
            echo "XRAY_TEST_KEYS=$RAW_KEYS" >> $GITHUB_ENV
            echo "GREP_PATTERN=$GREP_PATTERN" >> $GITHUB_ENV

            echo "‚úÖ TEST_PLAN_KEY: $TEST_PLAN_KEY"
            echo "‚úÖ RAW_KEYS: $RAW_KEYS"
            echo "‚úÖ GREP_PATTERN: $GREP_PATTERN"
          else
            # Manual run fallback (regex / tag)
            echo "GREP_PATTERN=${{ github.event.inputs.TAG }}" >> $GITHUB_ENV
            echo "‚úÖ Manual GREP_PATTERN: ${{ github.event.inputs.TAG }}"
          fi

      # ----------------------------------------------------
      # 3. Install Dependencies
      # ----------------------------------------------------
      - name: Install dependencies
        run: npm install
      - name: Install browserstack sdk
        run: npm i -D browserstack-node-sdk@latest
      
      # ----------------------------------------------------
      # 3.5 Install Playwright Browsers
      # ----------------------------------------------------
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # ----------------------------------------------------
      # 4. Setup BrowserStack Build + Project
      # ----------------------------------------------------
      - name: BrowserStack Env Setup
        uses: browserstack/github-actions/setup-env@master
        with:
          username: ${{ secrets.BROWSERSTACK_USERNAME }}
          access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          build-name: "SBM Playwright - ${{ github.run_number }}"
          project-name: "SBM"        
      

      # ----------------------------------------------------
      # 5. Start BrowserStack Local Tunnel
      # ----------------------------------------------------
      - name: Start BrowserStack Local
        uses: browserstack/github-actions/setup-local@master
        with:
          local-testing: start
          local-identifier: ${{ github.run_id }}
      - name: Debug BrowserStack config
        run: |
          echo "browserstack.yml:"
          cat browserstack.yml || true
          echo "browserstack.json:"
          cat browserstack.json || true
      # ----------------------------------------------------
      # 6. Run Playwright Tests (by Jira keys regex or manual input)
      # ----------------------------------------------------
      - name: Run Playwright tests (BrowserStack)
        continue-on-error: true
        shell: bash
        run: |
          echo "Running tests by grep: $GREP_PATTERN"
          if [ -z "$GREP_PATTERN" ]; then
            echo "‚ùå No test keys / grep pattern found. Failing run."
            exit 1
          fi
          npx browserstack-node-sdk playwright test --grep "$GREP_PATTERN"

      # ----------------------------------------------------
      # 7. Stop BrowserStack Local Tunnel
      # ----------------------------------------------------
      - name: Stop BrowserStack Local
        if: always()
        uses: browserstack/github-actions/setup-local@master
        with:
          local-testing: stop

      # ----------------------------------------------------
      # 8. Generate Allure ZIP Report
      # ----------------------------------------------------
      - name: Generate Allure ZIP Report
        if: always()
        run: npm run report:zip

      # ----------------------------------------------------
      # 9. Convert Allure ‚Üí XRAY JSON (and copy output to repo root)
      # ----------------------------------------------------
      - name: Convert Allure to XRAY JSON
        if: always()
        shell: bash
        run: |
          npx ts-node Utils/ExportToJsonv2.ts

          echo "üìÅ Listing allure-report/data:"
          ls -la allure-report/data || true

          # Your script writes to: allure-report/data/xray-import.json
          # Copy to repo root so later steps can find it easily
          if [ -f "allure-report/data/xray-import.json" ]; then
            cp allure-report/data/xray-import.json ./xray-import.json
            echo "‚úÖ Copied xray-import.json to repo root"
          else
            echo "‚ùå xray-import.json not found in allure-report/data"
            exit 1
          fi

      # ----------------------------------------------------
      # 10. Upload Artifacts (non-blocking + short retention)
      # ----------------------------------------------------
      - name: Upload Test Artifacts
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          retention-days: 3
          path: |
            allure-report.zip
            xray-import.json

      # ----------------------------------------------------
      # 11. Upload Results to XRAY (create execution + capture key)
      # ----------------------------------------------------
      - name: Upload Results to XRAY (create execution)
        if: always()
        shell: bash
        run: |
          if [ ! -f xray-import.json ]; then
            echo "‚ùå xray-import.json not found ‚Äî skipping XRAY upload"
            exit 0
          fi

          TOKEN=$(curl -s -X POST "https://xray.cloud.getxray.app/api/v2/authenticate" \
            -H "Content-Type: application/json" \
            -d "{\"client_id\":\"${{ secrets.XRAY_CLIENT_ID }}\",\"client_secret\":\"${{ secrets.XRAY_CLIENT_SECRET }}\"}" \
            | tr -d '"')

          echo "‚úÖ XRAY Token received"

          RESPONSE=$(curl -s -X POST "https://xray.cloud.getxray.app/api/v2/import/execution" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            --data-binary @xray-import.json)

          echo "‚úÖ XRAY Import response:"
          echo "$RESPONSE"

          EXECUTION_KEY=$(echo "$RESPONSE" | jq -r '.key // empty')

          if [ -z "$EXECUTION_KEY" ]; then
            echo "‚ùå Could not extract execution key from XRAY response"
            exit 1
          fi

          echo "‚úÖ Test Execution Key: $EXECUTION_KEY"
          echo "EXECUTION_KEY=$EXECUTION_KEY" >> $GITHUB_ENV

      # ----------------------------------------------------
      # 12. Attach Allure ZIP to Test Execution in Jira
      # ----------------------------------------------------
      - name: Attach Allure ZIP to Test Execution in Jira
        if: always()
        shell: bash
        run: |
          if [ -z "$EXECUTION_KEY" ]; then
            echo "‚ùå EXECUTION_KEY not found ‚Äî skipping attachment"
            exit 0
          fi

          FILE_PATH="allure-report.zip"

          if [ ! -f "$FILE_PATH" ]; then
            echo "‚ùå File $FILE_PATH not found ‚Äî skipping attachment"
            exit 0
          fi

          echo "‚úÖ Uploading attachment $FILE_PATH to Jira issue $EXECUTION_KEY"

          curl -X POST \
            -H "X-Atlassian-Token: no-check" \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -F "file=@allure-report.zip" \
            "https://${{ secrets.JIRA_DOMAIN }}/rest/api/3/issue/${EXECUTION_KEY}/attachments"
